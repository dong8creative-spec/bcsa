# 배포 방법 및 직접 확인 가이드

입찰공고 API(Functions) 변경 사항(캐시 TTL 5분, 기본 30일, 디버그 로그, nocache)을 배포하고 확인하는 방법입니다.

---

## 1. 배포 방법

### 1.1 배포 대상

- **변경된 코드**: `functions/index.js` (Firebase Cloud Functions)
- **실제 서비스 주소**: `https://apibid-oytjv32jna-du.a.run.app` (Firebase 프로젝트: bcsa-b190f)

### 1.2 사전 준비

1. **Firebase CLI 설치** (미설치 시)
   ```bash
   npm install -g firebase-tools
   ```

2. **로그인 및 프로젝트 선택**
   ```bash
   firebase login
   firebase use bcsa-b190f
   ```

3. **Functions 의존성 설치**
   ```bash
   cd functions
   npm install
   cd ..
   ```

### 1.3 Functions만 배포 (권장)

프론트/호스팅은 그대로 두고 **API(Functions)만** 배포할 때:

```bash
# 프로젝트 루트에서
npm run deploy:functions
```

또는:

```bash
firebase deploy --only functions
```

배포가 끝나면 터미널에 다음처럼 나옵니다.

```
✔  functions: Finished running deploy script.
i  functions: updating Node.js 20 function apiBid(asia-northeast3)...
✔  functions[apiBid(asia-northeast3)]: Successful update operation.
```

### 1.4 전체 배포 (호스팅 + Functions)

호스팅까지 함께 배포할 때:

```bash
npm run build
firebase deploy
```

> 참고: 이 프로젝트는 정적 사이트를 **GitHub Pages**로도 배포합니다(.github/workflows/deploy.yml).  
> API는 **Firebase Functions**만 배포하면 되고, 프론트는 GitHub Actions 또는 `firebase deploy --only hosting`으로 배포합니다.

---

## 2. 직접 확인하는 방법

### 2.1 기본 동작 확인 (브라우저 / curl)

**1) 헬스체크**

```bash
curl -s "https://apibid-oytjv32jna-du.a.run.app/health"
```

`{"status":"ok",...}` 이 나오면 서비스는 동작 중입니다.

**2) 입찰공고 검색 (날짜 없음 → 기본 30일)**

```bash
curl -s "https://apibid-oytjv32jna-du.a.run.app/api/bid-search?bidNtceNm=부산&numOfRows=5" | jq .
```

- `data.totalCount`, `data.items` 길이 확인
- `data.searchParams.dateRange` 에서 요청에 사용된 날짜 구간 확인 (기본 최근 30일)

**3) 캐시 우회 (nocache)**

```bash
curl -s "https://apibid-oytjv32jna-du.a.run.app/api/bid-search?bidNtceNm=부산&numOfRows=5&nocache=true" | jq .
```

- `meta.nocacheUsed: true` 인지 확인
- 같은 키워드로 `nocache=true` / 없음 두 번 호출해 보면, nocache일 때만 매번 G2B를 타는지 비교 가능

**4) 캐시 사용 여부**

- 첫 요청: `cached: false` 또는 필드 없음
- 5분 이내 같은 키워드 재요청(날짜 조건 동일): `cached: true` 가능
- 5분 지난 뒤 같은 키워드 재요청: 다시 `cached: false` 로 G2B 호출

### 2.2 디버그 로그 확인 (G2B URL, 원시 건수)

로그는 **Google Cloud Console**에서 봅니다.

1. [Google Cloud Console](https://console.cloud.google.com) 접속
2. 상단 프로젝트에서 **bcsa-b190f** 선택
3. 왼쪽 메뉴: **로그 탐색** (Logging → Logs Explorer)
4. 리소스: **Cloud Run** → 서비스 **apiBid** 선택
5. 검색창에 다음처럼 입력해 필터:

   ```
   textPayload=~"G2B"
   ```

   또는

   ```
   textPayload=~"Request URL"
   textPayload=~"Raw response"
   ```

**확인할 로그 예시**

- `[G2B] Request URL: https://apis.data.go.kr/...?ServiceKey=***&...`  
  → G2B에 나가는 URL (ServiceKey는 *** 로 마스킹됨)
- `[G2B] Raw response getBidPblancListInfoThngPPSSrch items: 10 totalCount: 20`  
  → 필터/캐시 적용 전, G2B가 준 그대로의 건수

### 2.3 TTL 5분 확인

1. **캐시 채우기**: 날짜 없이 키워드만 넣어 검색 1회  
   예: `GET /api/bid-search?bidNtceNm=부산&numOfRows=10`
2. **즉시 재요청** (같은 조건, nocache 없음):  
   응답에 `cached: true` 가 나올 수 있음 (캐시 적중)
3. **5분 이상 기다린 뒤** 같은 조건으로 다시 요청:  
   `cached: false` 로 바뀌고, 로그에 `[G2B] Request URL` 이 다시 찍히면 TTL 만료 후 재호출된 것

### 2.4 기본 30일 구간 확인

1. **날짜 파라미터 없이** 요청:
   ```bash
   curl -s "https://apibid-oytjv32jna-du.a.run.app/api/bid-search?bidNtceNm=부산&numOfRows=3" | jq '.data.searchParams.dateRange'
   ```
2. Cloud Logging에서 해당 요청 시점 로그 확인:
   - `✅ [Date] 기본값 (최근 30일) 사용:` 다음에 나오는 `inqryBgnDt`, `inqryEndDt` 가 30일 구간인지 확인

### 2.5 npm 검증 스크립트 (선택)

프로젝트 루트에서:

```bash
# 검색어 "부산"으로 프록시 호출 후 요약 출력
npm run verify:bid-search

# strict: 3개 API(또는 이중검색 시 6개) 모두 성공 시에만 성공
npm run compare:bid-search

# 검색어 3종(부산, 용역, 서울) 각각 검증
npm run test:bid-search-keywords
```

배포 직후에는 **nocache** 로 실제 G2B와 동작을 비교할 수 있습니다:

```bash
# .env.development 또는 환경변수로 API URL이 apibid 주소로 되어 있어야 함
node scripts/verify-bid-search.mjs --keyword 부산 --strict
# 또는 nocache 플래그를 스크립트에 추가해 사용
```

---

## 3. 요약 체크리스트

| 확인 항목 | 방법 |
|----------|------|
| 배포 성공 | `firebase deploy --only functions` 후 ✔ 표시 확인 |
| 서비스 동작 | `curl .../health` → 200, `status: ok` |
| 기본 30일 | 날짜 없이 검색 → 로그에 "최근 30일" 및 inqryBgnDt/EndDt (30일 구간) |
| TTL 5분 | 5분 이내 재요청 시 캐시 가능, 5분 후 재요청 시 G2B 재호출 |
| nocache | `?nocache=true` → 응답 `meta.nocacheUsed: true`, 캐시 미사용 |
| 디버그 로그 | Cloud Logging에서 `[G2B] Request URL`, `[G2B] Raw response` 검색 |

이 가이드대로 배포한 뒤 위 항목만 확인하면, 배포와 동작을 직접 검증할 수 있습니다.
