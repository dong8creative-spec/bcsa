# 나라장터와 검색결과 동일화 설계

우리 사이트 검색결과가 **나라장터 웹**과 같은 조건에서 **똑같이** 나오도록 하기 위한 과정을 단계별로 설계합니다. 각 단계는 검토 후 적용합니다.

---

## 1. 목표

- **동일 조건**: 검색어·조회 기간·업무구분·기타 필터가 같을 때
- **동일 결과**: 1페이지 건수·공고번호 목록·순서가 나라장터 1페이지와 일치 (또는 가능한 한 근접)

---

## 2. 현재 상태 요약

| 항목 | 우리 구현 | 비고 |
|------|-----------|------|
| 검색 범위 | **단일 API**: 키워드는 공고명(bidNtceNm), 상세조건 기관명은 insttNm으로 전달. 이중 검색 미사용 | 나라장터 "검색어" = 공고명 OR 기관명과 다를 수 있음 |
| API 호출 | 타입별 1회 (물품/용역/공사 등). 단일 호출 | |
| 서버 재필터 | 키워드가 공고명·공고기관명·수요기관명 중 하나라도 포함된 항목만 유지 | G2B API가 더 넓게 주면 우리가 줄임 |
| 정렬 | `bidNtceDt`(게시일시) 내림차순 | 나라장터도 등록일시 기준일 가능성 높음 |
| 페이지 | `pageNo`, `numOfRows`(기본 10) | API와 동일 |
| 캐시 | 키워드+type+inqryBgnDt+inqryEndDt. TTL 5분 | |

**차이가 날 수 있는 지점**

1. **검색 범위**: 현재 **단일 API**만 사용(공고명=키워드, 기관명=상세조건). 나라장터 웹은 "검색어"로 공고명 OR 기관명을 함께 검색하므로, "기관명에만 검색어가 있는" 공고는 우리 결과에 없을 수 있음. 기관명으로 찾을 때는 상세조건에서 기관명을 입력하면 됨.
2. **재필터**: 우리가 "검색어 포함"만 남기면 건수가 줄어들 수 있음. 나라장터가 API 원문 그대로 보여주면 순서/건수 차이 가능.
3. **정렬/페이지**: 정렬 키나 페이지 크기가 다르면 1페이지 구성이 달라짐.

---

## 3. 동일화 과정 (단계별, 검토 후 적용)

### 3.1 1단계: 기준선 측정

**목적**: 나라장터 1페이지와 우리 1페이지를 같은 조건으로 비교해, **어디서부터** 다른지 기록합니다.

**절차**

1. **샘플 조건 정하기**  
   예: 검색어 "범일역", 기간 최근 30일, 업무구분 전체.
2. **나라장터에서**  
   동일 조건으로 검색 → 1페이지 **공고번호 목록**(순서대로)·전체 건수·정렬 기준(등록일시 등)을 스크린샷 또는 메모로 기록.
3. **우리 사이트에서**  
   동일 조건으로 검색 (`nocache=true` 권장) → 1페이지 공고번호 목록·totalCount·정렬 확인.
4. **비교**  
   - 우리에 없는 공고: 나라장터에서 해당 공고의 "공고명" vs "기관명"에 검색어가 어디에 포함되는지 확인 → **검색 범위 차이** 여부 판단.  
   - 순서가 다름: 정렬 키(필드명·오름/내림) 확인.  
   - 건수만 다름: 재필터·페이지 크기 영향 가능.

**우리 1페이지 결과 출력 (CLI)**  
동일 조건으로 우리 API 1페이지를 **순번·공고번호·공고명** 형태로 출력하려면:

```bash
node scripts/verify-bid-search.mjs --keyword 범일역 --from 2026-01-01 --to 2026-01-31 --baseline-print
```

`--baseline-print` 사용 시 `nocache=true`로 요청해 캐시 없이 최신 결과를 가져옵니다. 출력된 표를 나라장터 1페이지 공고번호·순서와 나란히 비교하면 됩니다.

**산출물**: 1~2개 샘플에 대한 "나라장터 1페이지 vs 우리 1페이지" 비교표(공고번호, 순서, 건수, 비고).

---

### 1단계 기준선 측정 결과 (검색어 "부산", 2026-02-03 기준)

**우리 페이지**
- 공고명: "부산"
- 공고/개찰일자: 비어 있음(또는 기본값 최근 30일)
- 공고종류: "전체"
- 입찰마감제외: 미체크
- 1페이지 예시: R26BK01270779(2026-01-13), R26BK01270659(2026-01-13), R26BK…(2026-01-09) 등 — **게시일이 1월**인 공고가 상위에 노출

**나라장터**
- 공고명: "부산"
- 공고/개찰일자: **2026/01/04 ~ 2026/02/03 (최근1개월)**
- 공고종류: **"실공고"**
- **입찰마감제외: 체크**
- 1페이지: **6건**, 모두 **2026/02/03 게시** — R26BK01310477-001, R26BK01312406-000, R26BK01312276-000, R26BK01310449-001, R26BK01312168-000, 9253060-00

**차이 요약**

| 구분 | 우리 | 나라장터 | 비고 |
|------|------|----------|------|
| 조회 기간 | 날짜 비어 있으면 백엔드 기본 "최근 30일" | 2026/01/04~02/03 (최근1개월) | 기간은 동일할 수 있으나, **우리 1페이지가 1월 게시**·나라장터는 **2/3 게시**만 노출 → 조건/필터 차이 가능 |
| 입찰마감제외 | UI만 있음, **API로 전달 안 함** | **체크** → 마감된 입찰 제외 | 결과 집합이 달라지는 **주요 원인** 후보 |
| 공고종류 | "전체" | "실공고" | 실공고만 보이면 건수·목록 차이 가능 |
| 1페이지 공고번호 | R26BK01270779, R26BK01270659 … | R26BK01310477-001, R26BK01312406-000 … | **완전히 다른 공고 목록** → 위 조건(마감제외·공고종류·기간 해석) 정렬 필요 |

**다음 조치**
1. **입찰마감제외**: 적용함. 프론트 `excludeDeadline`을 API에 전달하고, 백엔드에서 마감일(`bidClseDt`/`bidClsDt`)이 지난 공고를 서버에서 제거. 나라장터 "입찰마감제외" 체크와 동일 동작. (입찰마감제외 사용 시 캐시 미사용.)
2. **공고종류**: 나라장터 "실공고"는 이미 `bidNtceDtlClsfCd` 옵션으로 지원. 우리 기본값은 "전체"이며, 동일 결과를 원하면 검색 시 "실공고" 선택.
3. **기간·정렬**: 날짜 비어 있을 때 "최근 30일" 사용. 동일 조건(기간 2026/01/04~02/03, 입찰마감제외 체크, 실공고)으로 재측정 권장.

---

### 3.2 2단계: 검색 범위 정렬

**목적**: 나라장터가 "검색어 = 공고명 OR 기관명"으로 보여준다면, 우리도 그에 맞춥니다.

**옵션 A — 이중 검색 재도입 (공고명 + 기관명 병합)**

- **동작**: 키워드만 있고 상세조건 기관명이 비어 있으면  
  - (1) `bidNtceNm=키워드`, `insttNm=비움` → 공고명 검색  
  - (2) `bidNtceNm=비움`, `insttNm=키워드` → 기관명 검색  
  두 결과를 **합친 뒤** `bidNtceNo`+차수 기준 중복 제거, **동일 정렬**(예: bidNtceDt 내림), **재필터**(검색어 포함) 적용 후 페이지네이션.
- **캐시**: 이미 키워드+inqryBgnDt+inqryEndDt+type 기준이므로, 이중 검색 결과도 기간별로 안정적으로 캐시 가능.
- **주의**: 병합 시 정렬 키·페이지 경계를 나라장터와 맞추려면 3.3 단계와 함께 조정.

**옵션 B — 단일 API 유지**

- **동작**: 지금처럼 `bidNtceNm=키워드`만 사용. 기관명에만 검색어가 있는 공고는 나오지 않음.
- **문서화**: "검색어는 공고명 검색에만 사용됩니다. 기관명으로만 찾으려면 상세조건에서 기관명을 입력하세요." 등으로 안내.

**선택**: 1단계 측정에서 "기관명에만 있는 공고"가 나라장터에 많다면 **옵션 A**, 적거나 무시 가능하면 **옵션 B**.

---

### 3.3 3단계: 정렬·페이지 일치

**목적**: 1페이지에 나오는 항목 집합과 순서를 나라장터에 맞춥니다.

- **정렬**: 나라장터가 사용하는 필드(예: 등록일시 `bidNtceDt`)와 오름/내림을 확인한 뒤, 우리도 동일 필드·동일 순서로 정렬.
- **페이지 크기**: 나라장터 기본이 10건/20건 등이면 우리 `numOfRows` 기본값을 그에 맞춤 (프론트/API 기본값 동일하게).
- **이중 검색 사용 시**: 병합 후 **한 번만** 정렬·페이지네이션 적용. 정렬 키는 나라장터와 동일하게 유지.

---

### 3.4 4단계: 재필터 정책

**목적**: "검색어 포함" 서버 재필터가 나라장터와 맞는지 결정합니다.

- 나라장터가 **검색어가 포함된 공고만** 보여준다면 → 우리 재필터 **유지**.
- 나라장터가 **API가 준 결과 그대로** 보여준다면 → 우리 재필터 **제거** 또는 쿼리 파라미터로 끄는 옵션 추가.

1단계에서 "우리 건수가 항상 더 적다"면 재필터가 원인일 수 있으므로, 나라장터 화면과 비교해 결정.

---

## 4. 적용 순서 제안

| 순서 | 단계 | 산출물 | 검토 후 |
|------|------|--------|---------|
| 1 | 3.1 기준선 측정 | 샘플 1~2건 비교표 (공고번호·순서·건수) | 다음 단계 선택 |
| 2 | 3.2 검색 범위 | 옵션 A(이중 검색) 또는 B(단일 유지) 코드 반영 | 적용 |
| 3 | 3.3 정렬·페이지 | 정렬 키·numOfRows 기본값 반영 | 적용 |
| 4 | 3.4 재필터 | 재필터 유지/제거/옵션화 | 적용 |
| 5 | 문서 정리 | 검증 가이드·안정화 가이드에 "동일화 기준" 반영 | 적용 |

---

## 5. 참고

- **검증 절차**: [나라장터_검색결과_검증_가이드.md](나라장터_검색결과_검증_가이드.md) — 동일 조건 맞추기·결과 비교·원인 구분.
- **검색 동작·캐시**: [검색결과_안정화_가이드.md](검색결과_안정화_가이드.md) — 단일 API 호출·재필터·캐시·운영 체크리스트.
- **코드**: `functions/index.js` — buildApiUrl(bidNtceNm, insttNm), 단일 callSpecs, 재필터, 정렬, getCachedBids/save 캐시.

이 설계대로 1단계 측정부터 진행한 뒤, 결과를 바탕으로 2~4단계를 검토·적용하면 나라장터와 검색결과를 똑같이 맞추는 과정을 안정적으로 진행할 수 있습니다.
