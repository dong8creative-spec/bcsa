# 모바일 결제 설정 가이드

모바일에서 결제가 원활히 동작하도록 **운영자(사용자)가 직접 수행해야 할 작업**을 단계별로 정리했습니다. 코드 배포는 개발에서 처리하며, 아래는 PortOne 콘솔·환경 변수·검증만 담당합니다.

---

## 1. PortOne 관리자 콘솔 설정

| 순서 | 작업 | 상세 |
|------|------|------|
| 1 | 로그인 | [PortOne 관리자](https://admin.portone.io) 접속 후 로그인합니다. |
| 2 | 가맹점 식별코드 확인 | **연동 정보** → **식별코드·API Keys**에서 **가맹점 식별코드**(Store ID 또는 구 식별코드)를 복사합니다. 이 값이 `VITE_PORTONE_IMP_CODE`에 들어갑니다. |
| 3 | 채널 및 PG 연결 | **채널 관리**에서 사용할 채널(실연동 또는 테스트)을 선택한 뒤, **PG사**(이니시스, 나이스페이 등)가 연결되어 있는지 확인합니다. 모바일 결제를 쓰려면 해당 채널에 **모바일 결제 가능 PG**가 반드시 연결되어 있어야 합니다. 연결이 없으면 "등록된 PG 설정 정보가 없습니다" 오류가 납니다. |
| 4 | 채널 키 복사 | 같은 채널의 **채널 키**(channel-key-xxx)를 복사합니다. 이 값이 `VITE_PORTONE_CHANNEL_KEY`에 들어갑니다. |
| 5 | 웹훅 URL 확인 | **결제 연동** → **웹훅**에서 Endpoint URL이 `https://apibid-oytjv32jna-du.a.run.app/api/payment/webhook` 로 설정되어 있는지 확인합니다. 이미 되어 있으면 생략해도 됩니다. |

---

## 2. 환경 변수 값 설정 (배포 방식별)

빌드 시점에 아래 값이 들어가야 모바일 결제가 동작합니다. **어디에 넣는지**는 사용 중인 배포 방식에 따라 다릅니다.

### 2-1. GitHub Actions로 빌드 후 배포하는 경우

저장소에 `.env.production`을 커밋하지 않을 때는 **GitHub Secrets**에 값을 넣어야 합니다.

1. GitHub Repository → **Settings** → **Secrets and variables** → **Actions**로 이동합니다.
2. **New repository secret**으로 아래 세 개를 추가합니다.

| Secret 이름 | 설명 | 예시 값 |
|-------------|------|---------|
| `VITE_API_URL` | 백엔드 API 기본 URL | `https://apibid-oytjv32jna-du.a.run.app` |
| `VITE_PORTONE_IMP_CODE` | 1단계에서 복사한 가맹점 식별코드(Store ID) | `store-2434eef7-527e-42e4-8c0d-af4886b24aac` |
| `VITE_PORTONE_CHANNEL_KEY` | 1단계에서 복사한 채널 키 | `channel-key-81244af5-2c76-4f35-a692-66e76558548d` |

3. 저장 후 다음 푸시부터 CI 빌드 시 위 값이 자동으로 반영됩니다.

### 2-2. 로컬에서만 빌드 후 Firebase Hosting 배포하는 경우

프로젝트 루트에 `.env.production` 파일을 만들고 아래 내용을 넣습니다. (이미 있으면 해당 변수만 수정합니다.)

```
VITE_API_URL=https://apibid-oytjv32jna-du.a.run.app
VITE_PORTONE_IMP_CODE=여기에_가맹점_식별코드
VITE_PORTONE_CHANNEL_KEY=여기에_채널_키
```

- `npm run build` 실행 후 `firebase deploy --only hosting`으로 배포합니다.
- `.env.production`에 비밀 값이 있으므로 `.gitignore`에 넣어 저장소에 올리지 않도록 합니다.

### 2-3. 로컬 개발 시

프로젝트 루트의 `.env.development` 또는 `.env.local`에 위와 동일한 변수명·값을 넣습니다. `.env.local`이 있으면 그쪽이 우선 적용됩니다.

---

## 3. 배포 후 검증

| 순서 | 작업 |
|------|------|
| 1 | 실제 모바일 기기 또는 Chrome 개발자도구에서 모바일 UA로 bcsa.co.kr에 접속합니다. |
| 2 | 유료 프로그램 신청 화면까지 이동한 뒤 결제 버튼을 클릭합니다. |
| 3 | 결제창(리다이렉트)이 정상적으로 뜨는지, 결제 완료 후 `/payment/result`로 돌아오는지 확인합니다. |
| 4 | (선택) 브라우저 콘솔에 "등록된 PG 설정 정보가 없습니다" 메시지가 없어졌는지 확인합니다. |

---

## 4. 서버 측 결제 취소 API용 환경 변수 (선택)

신청 취소·환불 API를 사용하는 경우, Firebase Functions(또는 Cloud Run) 쪽에도 PortOne 키가 필요합니다.

1. PortOne 관리자 → **연동 정보** → **API Keys**에서 **REST API Key**와 **REST API Secret**을 확인합니다.
2. Firebase 콘솔 또는 Google Cloud Console에서 해당 Functions/Cloud Run 서비스의 **환경 변수**에 아래를 설정합니다.
   - `PORTONE_API_KEY`: REST API Key
   - `PORTONE_API_SECRET`: REST API Secret
3. 로컬에서 Functions 에뮬레이터를 쓸 때는 `functions/.env` 또는 `firebase functions:config:set`으로 같은 이름으로 설정합니다.

---

## 요약 체크리스트

- [ ] PortOne 관리자에서 가맹점 식별코드·채널 키 확인
- [ ] 사용할 채널에 PG(결제대행사) 연결됨
- [ ] 웹훅 URL이 `https://apibid-oytjv32jna-du.a.run.app/api/payment/webhook` 로 설정됨
- [ ] 배포 방식에 맞게 `VITE_API_URL`, `VITE_PORTONE_IMP_CODE`, `VITE_PORTONE_CHANNEL_KEY` 설정 (GitHub Secrets 또는 `.env.production` 등)
- [ ] 모바일에서 결제 플로우 end-to-end 검증 완료
