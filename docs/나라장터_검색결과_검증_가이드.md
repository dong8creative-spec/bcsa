# 나라장터 vs 홈페이지 검색결과 검증 가이드

검색어 "부산"에 대해 나라장터 웹 결과와 홈페이지(프록시 API) 결과가 같은지 검증하고, 다를 경우 원인이 **프록시 서버 오류**인지 **API 호출/파라미터 문제**인지 구분하는 절차입니다.

---

## 1. 동일 조건 맞추기

- **검색어**: 부산 (동일)
- **날짜 범위**: 나라장터 스크린샷/화면에서 보이는 기간과 동일하게 설정  
  예: 2026-01-08 ~ 2026-01-31
- **기타**: 업무구분·공고종류 등 나라장터에서 선택한 조건이 있으면 홈페이지에서도 가능한 한 동일하게 설정

---

## 2. 검증 시 수행할 작업

### 2.1 브라우저에서 동일 조건 검색

1. 입찰공고 페이지에서 **공고명**에 "부산" 입력
2. **공고/개찰일자**를 나라장터와 동일한 기간으로 설정 (시작일·종료일)
3. **검색** 버튼 클릭

### 2.2 검증 정보 패널 확인 (UI)

검색 결과 테이블 아래 **「검증 정보 (나라장터 결과 비교용)」** 를 펼쳐 다음을 확인합니다.

- **cached**: `true` 이면 Firestore 캐시에서 반환된 결과 (실제 조달청 API 미호출)
- **totalCount**: 전체 건수
- **meta.apiCallCount**, **meta.successfulCalls**, **meta.partialFailure**: API 호출 성공/실패 여부
- **전송 요청 파라미터**: 실제로 전송된 `bidNtceNm`, `fromBidDt`, `toBidDt` 등

### 2.3 Network 탭 확인

1. 브라우저 개발자 도구(F12) → **Network** 탭
2. 요청 `https://apibid-oytjv32jna-du.a.run.app/api/bid-search?...` 선택
3. 확인 항목:
   - **HTTP 상태**: 200 / 4xx / 5xx
   - **Response body**: `success`, `data.items`, `data.totalCount`, `cached`

### 2.4 결과 테이블과 나라장터 비교

- **공고번호 목록**: 나라장터에 보인 공고번호(예: R26BK01270779 등)가 홈페이지 1페이지 결과에 모두 포함되는지
- **순서**: 게시일시 기준 정렬이 비슷한지
- **필드 값**: 공고명, 공고기관, 수요기관, 게시일시, 마감일시가 일치하는지

### 2.5 (선택) 프록시 직접 호출

동일 조건으로 프록시만 호출해 응답 요약을 확인할 수 있습니다.

```bash
# 검색어 "부산", 기본 날짜(최근 30일)
npm run verify:bid-search

# 검색어 "부산", 날짜 지정 (YYYYMMDD)
node scripts/verify-bid-search.mjs --keyword 부산 --from 2026-01-08 --to 2026-01-31

# API URL 지정
VITE_API_URL=https://apibid-oytjv32jna-du.a.run.app node scripts/verify-bid-search.mjs --keyword 부산
```

스크립트는 HTTP 상태, `success`, `cached`, `totalCount`, `items` 길이, 공고번호 목록(최대 10건), `meta` 및 검증 체크리스트 판단을 출력합니다.

### 2.6 3개 API 성공 여부 자동 판정 (compare:bid-search)

용역 API 수정 후 **물품/용역/공사 3개 API가 모두 성공**했는지 확인하려면:

```bash
npm run compare:bid-search
```

이 명령은 `--keyword 부산 --strict` 옵션으로 프록시를 호출한 뒤, `meta.successfulCalls` 가 호출한 API 수(예: 물품·용역·공사 3개면 3)와 같고 `meta.partialFailure === false` 일 때만 exit 0으로 종료합니다. 일부 API가 404 등으로 실패하면 exit 1로 종료됩니다.

### 2.7 검색 범위 (공고명 + 기관명 이중 검색)

나라장터와 동일하게, **검색어만 입력하고 상세조건 기관명을 비우면** 프록시는 **공고명 검색**과 **기관명 검색**을 모두 수행한 뒤 결과를 병합·중복 제거합니다.

- **공고명 검색**: `bidNtceNm`(공고명)에 검색어 전달
- **기관명 검색**: `insttNm`(기관명)에 검색어 전달
- **병합**: 두 결과를 합친 뒤 입찰공고번호+차수 기준 중복 제거, 검색어 재필터(공고명·기관명·수요기관명 포함 여부), 정렬·페이지네이션

따라서 "부산"으로 검색하면 공고명에 "부산"이 포함된 공고와, 공고기관/수요기관명에 "부산"이 포함된 공고가 함께 나옵니다. API 호출 수는 물품·용역·공사 각각 2회(공고명+기관명)이며, `meta.dualSearch === true` 로 확인할 수 있습니다. 상세조건에서 **기관명**을 직접 지정한 경우에는 이중 검색을 하지 않고, 지정한 기관명으로만 검색합니다.

---

## 3. 결과가 다를 경우 — 원인 구분 (프록시 vs API)

아래 순서로 **프록시 오류**와 **API/파라미터/검색 범위 문제**를 구분합니다.

### 3.1 프록시(Cloud Run) 쪽 가능 원인

| 현상 | 판단 |
|------|------|
| Network에서 502, 504, timeout, CORS 오류 | **프록시/네트워크 오류** |
| 200이지만 `success: false` 또는 `data.items` 없음 | 프록시 내부 에러 처리 또는 파싱 실패 |
| 200 + `cached: true` + 나라장터와 건수·내용 다름 | **캐시로 인한 구식/상이 데이터** (실제 조달청 API 미호출) |

**확인 방법**: Network에서 apibid 요청의 상태 코드·body·`cached` 필드 확인.

### 3.2 API 호출·파라미터 쪽 가능 원인

| 현상 | 판단 |
|------|------|
| 우리 결과가 "공고명에 부산 있는 것"만 포함하고, "기관명에만 부산 있는 것"은 누락 | **API 검색 범위 차이** (bidNtceNm 단일 필드 vs 나라장터 웹의 복합 검색) |
| 날짜를 안 넣으면 프록시가 "최근 30일"로 채움. 나라장터와 기간이 다름 | 날짜/필수 파라미터 차이로 결과 집합 상이 |
| `meta.partialFailure: true` 또는 `warnings` 존재 | 물품/용역/공사 3개 API 중 일부 실패 → 결과 누락 가능 |
| 200 + items 비어 있음 | **API 호출/파라미터/키/트래픽** 문제 또는 해당 조건 결과 없음 |

**확인 방법**:
- 나라장터 웹과 우리 결과의 **공고번호 집합** 비교
- 우리 쪽에 없는 공고는 나라장터에서 "공고명에 부산 없음 / 기관명에만 부산 있음"인지 확인 → 검색 범위 차이 여부 판단
- Cloud Run(또는 에뮬레이터) 로그에서 `[Bid Search]` 로그로 전달된 파라미터·호출된 API 경로·에러 메시지 확인

### 3.3 원인 구분 체크리스트

| 확인 항목 | 판단 |
|-----------|------|
| apibid 요청 5xx / 타임아웃 / 연결 실패 | **프록시/네트워크 오류** |
| 200 + `cached: true` + 나라장터와 건수·내용 다름 | **캐시로 인한 구식/상이 데이터** |
| 200 + `cached: false` + 우리는 "공고명에 부산"만, "기관명에만 부산"은 누락 | **API 검색 범위 차이** |
| 200 + items 비어 있음 또는 일부 API 실패 로그 | **API 호출/파라미터/키/트래픽** 문제 |

---

## 4. 참고 코드 위치

- **프론트 요청 파라미터**: `src/components/TenderSearchFilter.jsx` — `mapSearchParamsToApiParams`, 검색 시 콘솔 `[API Request]` 로그
- **프록시 수신·API URL 구성**: `functions/index.js` 117~425행 — keyword/bidNtceNm, fromBidDt/toBidDt, buildApiUrl, optionalParams
- **캐시 사용**: `functions/index.js` 546~557행(캐시 hit), 904~961행(getCachedBids)
- **에러 메시지 노출**: `src/components/TenderSearchFilter.jsx` 417~443행

---

## 5. 수정 계획

원인 규명 후 필요한 수정(검색 범위 확대, 캐시 정책, 필드 매핑, 에러 메시지 등)은 **별도 설립**합니다. 본 가이드는 검증 절차와 프록시 vs API 원인 구분에만 해당합니다.

---

## 6. API 출처 및 검색·상세 API 안내

검색 결과 한계나 API 부족이 의심될 때 **공식 출처**에서 어떤 API를 쓰는지·어디를 보면 되는지 참고용입니다.

| 목적 | 참고할 곳 | 비고 |
|------|-----------|------|
| **공식 API 문서·목록** | [조달데이터허브](https://data.g2b.go.kr) (data.g2b.go.kr) | 나라장터 입찰공고정보서비스 등 오픈API 검색 |
| **목록/검색** | 나라장터 입찰공고정보서비스 → **입찰공고목록 정보에 대한 공사/용역/물품 조회** | 요청변수: inqryDiv, inqryBgnDt, inqryEndDt, bidNtceNm 등 |
| **상세/기초금액/첨부** | 같은 서비스 내 **입찰공고목록 정보에 대한 상세조회** (공사/용역/물품 상세조회) | bidNtceNo, bidNtceOrd 로 상세·첨부 URL 조회 |
| **검색 조건·한계** | 위 조회 API의 **요청변수·출력결과** 탭 | 등록일시/변경일시 기준, 날짜 범위 필수 등 |

- **검색 결과를 제한**하고 싶다면: 조회 API의 **요청변수**에서 `inqryBgnDt`, `inqryEndDt`, `inqryDiv` 등으로 기간·조건을 지정할 수 있는지 확인.
- **상세 내용(기초금액, 참가자격, 공고서)**이 필요하면: **상세조회** API 문서를 참고하고, 프록시가 해당 API를 호출하는지 코드에서 확인.
