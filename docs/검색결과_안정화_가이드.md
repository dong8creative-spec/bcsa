# 검색 결과 안정화 가이드

입찰공고 검색 결과가 자꾸 달라질 때 **Firebase에서 이용자가 직접 할 수 있는 조치**와 **운영·검증 체크리스트**입니다.

---

## 0. 검색 동작 방식

입찰공고 검색은 **타입별 단일 API 호출 + 서버 재필터** 기준으로 동작합니다.

- **단일 API 호출**: 업무구분(물품/용역/공사 등)별로 G2B(나라장터) API를 **각 1회만** 호출합니다. 공고명 검색어는 bidNtceNm, 상세조건 기관명은 insttNm으로 그대로 전달합니다. (공고명+기관명 이중 검색은 사용하지 않습니다.)
- **서버 재필터**: API 응답을 받은 뒤, 검색어가 공고명·공고기관명·수요기관명 중 하나라도 포함된 공고만 남깁니다. 그 다음 정렬·페이지네이션 후 클라이언트에 반환합니다.
- **캐시**: 키워드·타입·조회 기간(inqryBgnDt, inqryEndDt)이 같으면 Firestore `tenders` 캐시를 조회하며, 캐시 히트 시 G2B 호출 없이 캐시 결과를 반환합니다. TTL 5분, 신선도 3분. `nocache=true` 또는 입찰마감제외 사용 시 캐시를 사용하지 않습니다.

---

## 1. 검색 결과가 자꾸 달라질 때 — Firebase에서 할 수 있는 조치

### 1.1 Firestore 캐시로 인한 결과 차이

**원인**  
`tenders` 컬렉션에 검색 결과가 TTL(5분) 동안 캐시됩니다. 이전 검색(다른 날짜/다른 조건)이 캐시에 남아 있으면, 같은 키워드라도 **기간·조건이 다른 결과**가 나올 수 있습니다.

**이용자 조치**

1. **Firebase Console** → **Firestore Database** → `tenders` 컬렉션으로 이동합니다.
2. 문제가 되는 검색어로 캐시된 문서를 찾습니다.  
   - 문서 필드 `_metadata.keyword`가 해당 검색어인 문서만 삭제하면 됩니다.  
   - 또는 해당 검색어 관련 문서들을 선택 후 **삭제**합니다.
3. 삭제 후에는 다음 검색부터 G2B API를 다시 호출하므로 **최신·동일 조건** 결과로 갱신됩니다.

**대안**  
검색 시 쿼리 파라미터에 **`nocache=true`** 를 붙이면 해당 요청은 캐시를 쓰지 않고 항상 G2B만 호출합니다.  
(프론트에서 "새로고침" 또는 "캐시 무시 검색" 버튼으로 `nocache=true` 를 붙여 호출할 수 있습니다.)

---

### 1.2 Functions 환경/설정

**확인**  
Firebase Console → **Functions** → 해당 함수(예: apiBid) → **환경 변수**를 엽니다.

**G2B API 키** (`G2B_API_KEY` 또는 `G2B_SERVICE_KEY`)가 올바르게 설정되어 있는지 확인합니다.  
키 오류/만료 시 일부 API만 실패해 결과 건수·구성이 달라질 수 있습니다.

**직접 수정**  
환경 변수 탭에서 값을 수정한 뒤, 해당 함수를 **다시 배포**하면 반영됩니다. (환경 변수만 변경 시 재배포가 필요한 경우가 많습니다.)

**500 "API 키가 설정되지 않았습니다" 발생 시**  
입찰공고 검색 시 500과 위 메시지가 나오면 **Firebase Functions 환경 변수**가 비어 있는 경우입니다.  
1. Firebase Console → **Functions** → 해당 함수(apiBid) → **환경 변수** (또는 **구성** 탭)  
2. `G2B_API_KEY` 또는 `G2B_SERVICE_KEY` 에 공공데이터포털에서 발급한 조달청 API 키를 설정  
3. 저장 후 해당 함수 **다시 배포** (재배포해야 환경 변수가 반영됨)

---

### 1.3 검색 결과가 달라지는 것 자체를 줄이기

- **캐시 비우기**: 위 1.1처럼 특정 검색어의 `tenders` 문서를 삭제한 뒤 재검색합니다.
- **일시적으로 캐시 끄기**: 테스트/검증 시에만 `nocache=true` 를 사용합니다.
- **코드 배포**: 검색어 재필터링이 적용된 Functions를 배포하면, 같은 G2B 응답이라도 "검색어 포함 공고만" 남아 결과가 더 일관되게 나옵니다.

---

## 2. 운영·검증 체크리스트 ("정신 차리기")

### 배포 후

- 동일 **키워드**·동일 **날짜**로 **우리 사이트**와 **나라장터** 1페이지를 비교합니다 (건수, 공고번호 몇 개 샘플).
- `?nocache=true` 로 한 번 호출해 보면 캐시 영향 여부를 확인할 수 있습니다.

### 결과가 이상할 때

- Firestore `tenders` 에서 해당 검색어 캐시를 삭제한 뒤 재검색합니다.
- Functions 로그에서 `[Bid Search] Keyword re-filter`, `[Cache] Cache hit` 등으로 재필터·캐시 사용 여부를 확인합니다.

### 일치율 목표

- 공고명만 검색 시, "공고명/기관명에 검색어가 포함된 공고만" 보이도록 서버 재필터링이 적용되어 있습니다.
- 나라장터와 **같은 조건(날짜·키워드)** 으로 비교해 **80% 이상 일치**를 목표로 점검합니다.

---

## 3. 요약

| 상황 | 조치 |
|------|------|
| 같은 키워드인데 결과가 다르다 | Firestore `tenders` 에서 해당 검색어(`_metadata.keyword`) 문서 삭제 후 재검색 |
| 항상 최신 결과만 보고 싶다 | 요청에 `nocache=true` 추가 (테스트/검증 시) |
| API 오류/건수 이상 | Functions 환경 변수(G2B API 키) 확인 후 재배포 |
| 502 모든 API 실패 | 재시도 후, G2B API 상태·환경 변수(G2B API 키) 확인 (섹션 5.4 참고) |
| G2B resultCode 오류 | 섹션 5.2 표 참고 — 키·트래픽·도메인 등 확인 |
| 일치율 점검 | 동일 키워드·동일 날짜로 나라장터와 1페이지 비교, 로그에서 Keyword re-filter / Cache hit 확인 |

---

## 4. 기타 오류 시 조치

**400 "bidNtceNo는 필수"**  
입찰공고번호 기준 조회(`inqryDiv=2`)를 사용할 때는 **입찰공고번호(bidNtceNo)** 를 반드시 입력해야 합니다. API에서 해당 모드로 호출 시 bidNtceNo가 없으면 400이 반환됩니다. (현재 프론트는 등록일시 기준 조회만 사용하므로, API를 직접 호출할 때만 해당됩니다.)

**404 "해당 공고의 상세 정보를 찾을 수 없습니다" (bid-detail)**  
- 상세 API는 공고번호(bidNtceNo)와 차수(bidNtceOrd)로 조달청 상세 API를 호출합니다. 요청 시 **bidNtceOrd를 생략하면** 서버에서 000 → 001 → 1 순으로 재시도합니다.
- 목록에서 행 클릭 시 **검색 결과 항목의 bidNtceOrd를 그대로** 상세 API에 넘기면 정확도가 높습니다. 계속 404가 나오면 G2B(나라장터) 해당 공고 페이지에서 차수·공고종류를 확인하고, Functions 로그에서 `[Bid Detail] API success` / `bidNtceOrd=` 로 실제 사용된 차수를 확인할 수 있습니다.

---

## 5. G2B(나라장터) API 오류별 안내 (J1 / J2 / K1 / L1)

입찰공고 검색은 G2B API를 호출합니다. 아래는 외부 API·파싱 오류 시 의미와 대응입니다.

### 5.1 J1 — G2B 서버 오류·타임아웃·네트워크 오류

**의미**  
G2B 서버 4xx/5xx, 타임아웃, 네트워크 오류로 **해당 API 호출만** 실패할 수 있습니다.

**동작**  
- 타입별 단일 API 호출이므로, 일부 타입(물품/용역/공사)만 실패하면 나머지 결과만 반환될 수 있습니다 (warnings/partialFailure).
- **재시도**: 코드에서 일부 에러(예: resultCode 01)는 자동 재시도합니다.

**이용자 안내**  
- "잠시 후 다시 검색해 주세요."
- 계속되면 G2B(나라장터) API 점검 공지 또는 상태를 확인해 주세요.

---

### 5.2 J2 — G2B resultCode 비정상

G2B 응답 헤더의 **resultCode**가 00(성공)·03(데이터 없음)이 아닐 때입니다. 코드에서 아래와 같이 매핑되어 사용자에게 안내됩니다.

| resultCode | 의미 | 대응 |
|------------|------|------|
| 01 | 제공기관 서비스 불안정 | 잠시 후 다시 시도 (자동 재시도 대상) |
| 06 | 날짜 형식 오류 | YYYYMMDDHHMM 형식 확인 |
| 08 | 필수 파라미터 누락 | 요청 파라미터 확인 |
| 12 | API URL 오류 | 연동 코드/엔드포인트 확인 |
| 20 | API 활용 승인 미완료 | 공공데이터포털에서 API 신청·승인 확인 |
| 22 | 일일 트래픽 초과 | 다음날 재시도 또는 트래픽 한도 확인 |
| 30 | API 키 미등록/URL 인코딩 문제 | Firebase 환경 변수(G2B_API_KEY 등) 확인, 키·URL 인코딩 점검 |
| 31 | API 키 만료 | 공공데이터포털에서 키 갱신 후 환경 변수 반영·재배포 |
| 32 | 미등록 도메인/IP | 공공데이터포털에 호출 도메인/IP 등록 |

**운영자**  
- 30/31/32: Firebase Functions 환경 변수 및 공공데이터포털 키·도메인 설정을 확인한 뒤 재배포합니다.

---

### 5.3 K1 — XML/JSON 파싱 실패

**의미**  
G2B 응답 형식이 예상과 다르거나 손상되어 XML/JSON 파싱에 실패한 경우입니다.

**이용자 안내**  
- "응답 형식 오류가 발생했습니다. 잠시 후 다시 시도해 주세요."
- 계속되면 G2B(나라장터) 쪽 점검·장애 안내를 확인해 주세요.

---

### 5.4 L1 — 모든 API 요청 실패 시 502

**의미**  
(이중 검색 시 6회, 단일 검색 시 3회 등) 모든 API 호출이 실패하면 **502 Bad Gateway**를 반환합니다.

**응답 메시지**  
- "모든 API 요청이 실패했습니다. 잠시 후 다시 시도해 주세요. 계속되면 G2B(나라장터) API 상태 또는 Firebase Functions 환경 변수(G2B API 키)를 확인해 주세요."

**대응**  
1. 잠시 후 다시 검색(재시도).
2. Firebase Console → Functions → 환경 변수에서 **G2B API 키** 확인.
3. G2B(나라장터) API 상태·점검 공지 확인.

---

이 가이드대로 조치하면 검색 결과가 달라지는 현상을 줄이고, 운영 시 점검할 항목을 일관되게 확인할 수 있습니다.
