# 나라장터 입찰공고 검색 502 오류 해결 가이드

"조달청 API 호출 실패" 또는 브라우저 콘솔에 **502 Bad Gateway**가 나올 때 순서대로 확인하세요.

---

## 1. 502가 나오는 이유

- **우리 서버가 반환하는 502**: 물품/용역/공사 등 **모든 G2B(조달청) API 호출이 실패**했을 때
- **플랫폼이 반환하는 502**: Cloud Run/Firebase Functions 타임아웃·크래시·메모리 초과 등

아래 순서대로 점검하면 원인을 좁힐 수 있습니다.

---

## 2. 1단계: G2B API 키 설정 확인

### 2.1 배포된 함수에는 Firebase Console 환경 변수가 적용됨

- 로컬 `functions/.env` 또는 `functions/.envcd` 파일은 **배포 시 업로드되지 않습니다** (보안상 .env는 .gitignore에 있음).
- **실제 배포된 API**가 조달청을 호출하려면 **Firebase Console**에 키를 설정해야 합니다.

**확인 방법**

1. [Firebase Console](https://console.firebase.google.com) → 프로젝트(bcsa-b190f) 선택
2. **빌드** → **Functions** → **apibid** (또는 해당 HTTP 함수) 선택
3. **구성** 탭 또는 **환경 변수** 섹션에서 다음 중 하나 확인:
   - `G2B_API_KEY`
   - `G2B_SERVICE_KEY`

값이 비어 있거나 없으면 **502 원인**이 됩니다.

**설정 방법**

- **환경 변수**에 `G2B_API_KEY`(또는 `G2B_SERVICE_KEY`) = 공공데이터포털에서 발급한 **인증키(일반 인증키)** 입력
- 저장 후 **함수 재배포**가 필요할 수 있음: 터미널에서  
  `firebase deploy --only functions`

### 2.2 키 설정 여부 빠른 확인 (진단 API)

배포된 API에 다음 주소로 요청하면 **키 설정 여부만** 확인할 수 있습니다(키 값은 노출되지 않음).

```bash
curl -s "https://apibid-oytjv32jna-du.a.run.app/api/diagnose-g2b"
```

- `g2bKeyConfigured: true` → 환경 변수에 키가 설정되어 있음 (다른 원인 점검)
- `g2bKeyConfigured: false` → **Firebase Console에 G2B API 키를 설정한 뒤 재배포**

---

## 3. 2단계: Cloud Logging으로 실제 오류 확인

502가 우리 코드에서 나온 경우, **실패한 이유**가 로그에 남습니다.

1. Firebase Console → **Functions** → **로그** 또는 Google Cloud Console → **Logging**
2. 다음 문자열로 검색:
   - `[Bid Search]`
   - `[G2B]`
   - `All APIs failed`

**로그 예시와 의미**

| 로그/메시지 | 의미 | 대응 |
|------------|------|------|
| `API 키가 설정되지 않았습니다` / 키 관련 500 | 환경 변수에 키 없음 | 2단계(키 설정) 다시 확인 |
| `resultCode: 30` | API 키 미등록/URL 인코딩 문제 | 키 값·공공데이터포털 등록 확인 |
| `resultCode: 22` | 일일 트래픽 제한 초과 | 다음날 재시도 또는 트래픽 한도 확인 |
| `resultCode: 32` | 등록되지 않은 도메인/IP | 공공데이터포털에 서비스 URL·IP 등록 |
| `Timeout` / `ECONNABORTED` | 조달청 API 응답 지연(30초 초과) | 잠시 후 재시도, 조달청 API 상태 확인 |
| `Network Error` | 네트워크/방화벽 문제 | Blaze 플랜·VPC·방화벽 확인 |

---

## 4. 3단계: 공공데이터포털·조달청 API 상태 확인

- [공공데이터포털](https://www.data.go.kr) → **마이페이지** → **인증키**에서 해당 키 상태 확인  
  - 활용신청 완료 여부, **일일 한도**, **사용기한**
- 나라장터/조달청 **API 점검·장애 공지** 확인

---

## 5. 4단계: 플랫폼 502 (함수 타임아웃·크래시)

브라우저 Network 탭에서 **응답 본문**에 우리가 보내는 `error`, `message`가 아니라 **비어 있거나 다른 형식**이면, **Cloud Run/Functions 쪽 502**일 수 있습니다.

- **타임아웃**: 함수 제한 시간(예: 60초) 안에 G2B 호출이 끝나지 않음  
  → 조달청 API가 느릴 때 잠시 후 재시도
- **메모리/크래시**: 함수 로그에 예외 스택이 찍혀 있으면 코드/의존성 점검

---

## 6. 요약 체크리스트

- [ ] Firebase Console → Functions → **환경 변수**에 `G2B_API_KEY` 또는 `G2B_SERVICE_KEY` 설정
- [ ] 키 설정 후 필요 시 `firebase deploy --only functions` 재배포
- [ ] `GET /api/diagnose-g2b` 로 `g2bKeyConfigured` 확인
- [ ] Cloud Logging에서 `[Bid Search]`, `[G2B]` 로그로 실패 원인 확인
- [ ] 공공데이터포털 인증키 상태·일일 한도·도메인 등록 확인
- [ ] 조달청/공공데이터포털 API 점검 공지 확인

위 단계를 거쳐도 502가 계속되면, 로그에 찍힌 **에러 메시지·resultCode**를 함께 알려주면 원인 파악에 도움이 됩니다.
